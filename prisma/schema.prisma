// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("ONLINE_DATABASE_URL")
  //url     = env("LOCAL_DATABASE_URL")
}

enum BairrosRecife {
  AFLITOS
  AFOGADOS
  AGUA_FRIA
  ALTO_JOSE_BONIFACIO
  ALTO_JOSE_DO_PINHO
  ALTO_DO_MANDU
  ALTO_DO_PASCOAL
  ALTO_SANTA_TEREZINHA
  APIPUCOS
  AREIAS
  ARRUDA
  BARRO
  BEBERIBE
  BENFICA
  BOA_VIAGEM
  BOA_VISTA
  BOMBA_DO_HEMETERIO
  BONGI
  BRASILIA_TEIMOSA
  BREJO_DO_BEBERIBE
  BREJO_DA_GUABIRABA
  CABANGA
  CACOTE
  CAJUEIRO
  CAMPINA_DO_BARRETO
  CAMPO_GRANDE
  CASA_AMARELA
  CASA_FORTE
  CAXANGA
  CIDADE_UNIVERSITARIA
  COELHOS
  COHAB
  COQUE
  COQUEIRAL
  CORDEIRO
  CORREGO_DO_JENIPAPO
  CURADO
  DERBY
  DOIS_IRMAOS
  DOIS_UNIDOS
  ENCRUZILHADA
  ENGENHO_DO_MEIO
  ENTRA_A_PULSO
  ESPINHEIRO
  ESTANCIA
  FUNDAO
  GRACAS
  GUABIRABA
  HIPODROMO
  IBURA
  ILHA_JOANA_BEZERRA
  ILHA_DO_LEITE
  ILHA_DO_RETIRO
  IMBIRIBEIRA
  IPSEP
  IPUTINGA
  JAQUEIRA
  JARDIM_SAO_PAULO
  JIQUIA
  JORDAO
  LINHA_DO_TIRO
  MACAXEIRA
  MADALENA
  MANGABEIRA
  MANGUEIRA
  MONTEIRO
  MORRO_DA_CONCEICAO
  MUSTARDINHA
  NOVA_DESCOBERTA
  PAISSANDU
  PARNAMIRIM
  PASSARINHO
  PAU_FERRO
  PEIXINHOS
  PINA
  POCO_DA_PANELA
  PONTE_D_UCHOA
  PONTO_DE_PARADA
  PORTO_DA_MADEIRA
  PRADO
  RECIFE
  ROSARINHO
  SAN_MARTIN
  SANCHO
  SANTANA
  SANTO_AMARO
  SANTO_ANTONIO
  SAO_JOSE
  SITIO_DOS_PINTOS
  SOLEDADE
  TAMARINEIRA
  TEJIPIO
  TORRE
  TORREAO
  TORROES
  TOTO
  VARZEA
  VASCO_DA_GAMA
  ZUMBI
}

model VacinacaoBairro {
  id             Int           @id @default(autoincrement())
  nome           BairrosRecife @unique
  amountVaccines Int           @default(0)
}

// Perfil do usuário (pode ser Paciente ou Admin)
model Usuario {
  id                 Int            @id @default(autoincrement())
  cpf                String?        @unique
  nome               String?
  email              String?        @unique
  bairro             BairrosRecife?
  role               String         @default("user")
  conecta_recife_id  String?
  createdAt          DateTime       @default(now()) @map("criado_em")
  updatedAt          DateTime       @updatedAt @map("atualizado_em")
  latestConectaToken String?
  saldoCapibas       Int            @default(0)

  // RELAÇÕES
  // 1. Vacinas que este usuário recebeu como PACIENTE
  vacinacoesRecebidas VacinacaoUsuario[] @relation("PacienteVacinado")

  // 2. Vacinas que este usuário registrou como ADMIN
  vacinacoesRegistradas VacinacaoUsuario[] @relation("AdminRegistrou")

  // 3. Tipos de Vacina que este usuário criou como ADMIN
  vacinasCriadas Vacina[] @relation("AdminCriouVacina")

  @@map("usuarios")
}

// Tipos de Vacina (ex: Covid, Gripe)
model Vacina {
  id        Int      @id @default(autoincrement())
  nome      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ativo     Boolean  @default(true)

  // Auditoria: Qual admin criou este tipo de vacina?
  adminId      Int
  adminCriador Usuario @relation("AdminCriouVacina", fields: [adminId], references: [id])

  registros VacinacaoUsuario[]
}

// Registro da aplicação da vacina (Ação de vacinar)
model VacinacaoUsuario {
  id Int @id @default(autoincrement())

  dataAplicacao  DateTime
  localAplicacao String?
  earnedCapibas  Int      @default(50)

  // QUEM RECEBEU A VACINA (O PACIENTE)
  usuarioId Int
  usuario   Usuario @relation("PacienteVacinado", fields: [usuarioId], references: [id], onDelete: Cascade)

  // QUAL VACINA FOI APLICADA
  vacinaId Int
  vacina   Vacina @relation(fields: [vacinaId], references: [id], onDelete: Restrict)

  // QUEM REGISTROU A APLICAÇÃO (O ADMIN/ENFERMEIRO)
  adminId          Int
  adminRegistrador Usuario @relation("AdminRegistrou", fields: [adminId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now()) @map("criado_em")
  updatedAt DateTime @updatedAt @map("atualizado_em")

  // Impede duplicidade: O mesmo paciente não pode tomar a mesma vacina duas vezes
  @@unique([usuarioId, vacinaId])
}